{% extends 'base_waste.html' %}
{% load staticfiles %}
{% block cuerpo %}
	 <div class="content">
            <!-- Animated -->
            <div class="animated fadeIn">
                <!-- Widgets  -->
                <div class="row">
				
                    <div class="col-md-4 offset-md-3 mr-auto ml-auto">
                        <div class="card mb-3" style="max-width: 540px;">
								<div class="row no-gutters">
									<div class="col-lg-3">
										<p align="center">
										<br><img src="{% static 'images/dispositivo2.png' %}" height="65" width="70"/>
										</p>
									</div>
									<div class="col-lg-8">
										<div class="card-body">
											<div class="stat-widget-five">
												<div class="stat-text"><span class="count">{{n_dispositivos}}</span></div>
												<div class="stat-heading">Dispositivos Instalados</div>
											</div>
										</div>
									</div>
									
								</div>
						</div>
					</div>

					
					<!-- <div class="col-lg-4 col-md-5">
						<div class="card">
                            <div class="card-body">
                                <div class="stat-widget-five">
                                    <div class="stat-icon dib flat-color-3">
                                        <i class="menu-icon fa fa-truck"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="text-left dib">
                                            <div class="stat-text"><span class="count">{{n_dispositivos_llenos}}</span></div>
                                            <div class="stat-heading">Listos para recolectar</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
										
					
					<div class="col-lg-4 col-md-5">
						<div class="card">
                            <div class="card-body">
                                <div class="stat-widget-five">
                                    <div class="stat-icon dib flat-color-4">
                                        <i class="menu-icon fa fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="text-left dib">
                                            <div class="stat-text"><span class="count">0</span></div>
                                            <div class="stat-heading">Dispositivos con alarmas</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> -->
					
                </div>
			
			</div>
        

	
			
            <div class="animated fadeIn">
                <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <strong>MAPA</strong>
                            </div>
                            <div class="gmap_unix card-body">

                                <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
                                <script src = "https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type = "text/javascript"> </script>
                                <div id="map" style="width: 900px; height: 450px;"></div>
									<script type="text/javascript">
											var locations = [];
											/*var locations = [
											  ['Remedyar1', -0.891691, -78.611078, 1],
											  ['Remedyar2', -0.892095, -78.611217, 2],
											  ['Remedyar3', -0.889937, -78.610712, 3]
											];*/
											
											function nuevo_punto(nombre,latitud,longitud,n){
												locations.push([nombre,latitud,longitud,n])
											}
											
											function marcadores(){
											
												var map = new google.maps.Map(document.getElementById('map'), {
												  zoom: 18,
													center: new google.maps.LatLng(locations[0][1], locations[0][2]),
												  mapTypeId: google.maps.MapTypeId.ROADMAP
												});

												var infowindow = new google.maps.InfoWindow();

												var marker, i;
												
												for (i = 0; i < locations.length; i++) {
													var icon = {
														url: "http://104.248.229.139/static/images/basurero5.png", // url
														scaledSize: new google.maps.Size(36, 36), // scaled size
														//origin: new google.maps.Point(0,0), // origin
														//anchor: new google.maps.Point(18, 18) // anchor
													};
													
													marker = new google.maps.Marker({
														icon: icon,
														//icon: {url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"},
														position: new google.maps.LatLng(locations[i][1], locations[i][2]),
														map: map
													});
												  
												/*var circle = new google.maps.Circle({
													center: new google.maps.LatLng(locations[i][1], locations[i][2]),
													radius: 6,
													map: map,
													fillColor: "#00FFFF",
													fillOpacity: 0.2,
													strokeColor: "#000000",
													strokeOpacity: 0.9
												});
												
												map.fitBounds(circle.getBounds());*/
												
												google.maps.event.addListener(marker, 'click', (function(marker, i) {
													return function() {
													  //window.location.href = "http://104.248.229.139/estados_epagal/?n="+i;
													  infowindow.setContent("" + locations[i][0]);
													  infowindow.open(map, marker);
													  map.setZoom(18);
													  console.log(locations[i]);
													  var pt = new google.maps.LatLng(locations[i][1], locations[i][2]); 
													  //map.setCenter(marker.position);
													  map.panTo(marker.position);
													  //map.setCenter(new google.maps.LatLng(parseFloat(locations[i][1]), parseFloat(locations[i][2])));
													  
													  
													}
												  })(marker, i));
												}
											}

											

											//mqtt conexion
											/*var mqtt;
											var reconnectTimeout=2000;
											var host="104.248.229.139";
											var port=8083;

											mqtt=new Paho.MQTT.Client(host,port,"clientjs");
											function onConnect() {
												console.log("conectadoo");
												mqtt.subscribe("LUMINARIA1/UBICACION");
												mqtt.subscribe("LUMINARIA2/UBICACION");
												mqtt.subscribe("LUMINARIA3/UBICACION");

												message=new Paho.MQTT.Message("ubicacion");
												message.destinationName="SERVIDOR/LUMINARIA1/UBICACION";
												mqtt.send(message);
												message.destinationName="SERVIDOR/LUMINARIA2/UBICACION";
												mqtt.send(message);
												message.destinationName="SERVIDOR/LUMINARIA3/UBICACION";
												mqtt.send(message);

												console.log("msg_enviado");
											}
											function MQTTconnect() {
												console.log("conectando a "+host);
												var options={
													onSuccess: onConnect,
													onFailure: onFailure,
													userName:"freddy3e",
													password:"elec1994"
												};
												mqtt.connect(options);
												mqtt.onMessageArrived = onMessageArrived;
												console.log("options");
											}
											function onFailure(message) {
												console.log("Conection attempt to host" +host+"Failed")
											}
											function onMessageArrived(msg) {
												out_msg="Mensaje: " + msg.payloadString;
												out_msg=out_msg+"Topico: " + msg.destinationName;
												console.log(out_msg);

												nombre=msg.destinationName.substring(
													0,
													msg.destinationName.lastIndexOf("/")
												);

												latitud=parseFloat(msg.payloadString.substring(
													msg.payloadString.lastIndexOf("<") + 1,
													msg.payloadString.lastIndexOf(">")
												));

												longitud=parseFloat(msg.payloadString.substring(
													msg.payloadString.lastIndexOf("[") + 1,
													msg.payloadString.lastIndexOf("]")
												));

												var map = new google.maps.Map(document.getElementById('map'), {
													zoom: 18,
													center: new google.maps.LatLng(-0.229314, -78.523362),
													mapTypeId: google.maps.MapTypeId.ROADMAP
												});

												var infowindow = new google.maps.InfoWindow();

												var marker;

												marker = new google.maps.Marker({
												position: new google.maps.LatLng(latitud, longitud),
												map: map
											  });

											  google.maps.event.addListener(marker, 'click', (function(marker) {
												return function() {
												  infowindow.setContent(nombre);
												  infowindow.open(map, marker);
												}
											  })(marker));
											}*/


										</script>
										<script>
											//MQTTconnect();
										</script>


                            </div>
                        </div>
                        <!-- /# card -->
                </div>
			</div>
	</div>
	
	{% for i in dispositivos%}
		<script>
			nuevo_punto(String("{{i.FechaDispositivo}}"), parseFloat({{i.Latitud}}), parseFloat({{i.Longitud}}), parseFloat({{i.Imei}}));
		</script>
	{%endfor%}
   
    <script>
		marcadores();
	</script>  

		
		<!-- /.content -->
        <div class="clearfix"></div>
	



{% endblock %}